# Github workflows to Sentry

This app listens to GH webhook events from workflows events and stores the data as
transactions in Sentry.

## Pre-requisites

We're using Flask and for the development server you need to set some env variables. [direnv](https://github.com/direnv/direnv) is used to load the variables from the `env` file.

You're welcome to use some other tool to load these variables

## Requirements

- Python 3
- ngrok (for local dev)

### Set up

In order to submit envelopes to Sentry we need to use Relay.

These steps come from following the [documentation](https://docs.sentry.io/product/relay/getting-started/). The config file checked-in has been generated by downloading a [relay binary](https://github.com/getsentry/relay/releases):

```shell
./relay config init
```

Create your own Sentry project and use the `public_key` (from the `credentials.json` file) to register your Relay (see [docs](https://docs.sentry.io/product/relay/getting-started/#registering-relay-with-sentry) for details).
To verify that you can send envelopes via Relay you can swap `o19635.ingest.sentry.io` to `127.0.0.1:3000` and send an event:

```shell
SENTRY_DSN='http://<key>@127.0.0.1:3000/<proj_id>' sentry-cli send-event -m 'A test event'
```

Install ngrok, authenticate and start it up:

```shell
ngrok http 5000
```

Take note of the URL given and create a Github webhook (only `workflow` events & make sure to choose `application/json`) with that URL.

To start up the flask app:

```shell
cd 2021
# direnv loads three env variables
flask run
```
